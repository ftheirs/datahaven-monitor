name: Monitor – Testnet Sentinel

on:
  schedule:
    # Run every 15 minutes
    - cron: "*/15 * * * *"
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  monitor:
    name: Run Testnet Sentinel
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run monitor
        env:
          ACCOUNT_PRIVATE_KEY: ${{ secrets.ACCOUNT_PRIVATE_KEY }}
          DATAHAVEN_NETWORK: stagenet
          MONITOR_OUTPUT_DIR: badges
        run: bun run monitor

      - name: Publish badge endpoints to gh-pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: badges
          keep_files: false

      - name: Parse monitor status
        if: always()
        id: parse_status
        run: |
          # Parse the detailed monitor status
          if [ ! -f badges/monitor-status.json ]; then
            echo "monitor-status.json not found"
            exit 0
          fi

          # Show what we have
          echo "=== Monitor Status ==="
          cat badges/monitor-status.json
          echo "====================="

          # Extract key information
          OVERALL=$(jq -r '.overall' badges/monitor-status.json)
          PASSED=$(jq -r '.summary.passed' badges/monitor-status.json)
          FAILED=$(jq -r '.summary.failed' badges/monitor-status.json)
          SKIPPED=$(jq -r '.summary.skipped' badges/monitor-status.json)
          TOTAL=$(jq -r '.summary.total' badges/monitor-status.json)
          
          # Get failed stages
          FAILED_STAGES=$(jq -r '.stages[] | select(.status == "failed") | .name' badges/monitor-status.json | tr '\n' ',' | sed 's/,$//')
          
          # Get passed stages
          PASSED_STAGES=$(jq -r '.stages[] | select(.status == "passed") | .name' badges/monitor-status.json | tr '\n' ',' | sed 's/,$//')

          echo "overall=$OVERALL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "failed_stages=$FAILED_STAGES" >> $GITHUB_OUTPUT
          echo "passed_stages=$PASSED_STAGES" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          OVERALL: ${{ steps.parse_status.outputs.overall }}
          PASSED: ${{ steps.parse_status.outputs.passed }}
          FAILED: ${{ steps.parse_status.outputs.failed }}
          SKIPPED: ${{ steps.parse_status.outputs.skipped }}
          TOTAL: ${{ steps.parse_status.outputs.total }}
          FAILED_STAGES: ${{ steps.parse_status.outputs.failed_stages }}
          PASSED_STAGES: ${{ steps.parse_status.outputs.passed_stages }}
        run: |
          # Skip if webhook URL is not configured
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL not configured, skipping notification"
            exit 0
          fi

          # Skip if status wasn't parsed (monitor didn't run)
          if [ -z "$OVERALL" ]; then
            echo "No monitor status to report"
            exit 0
          fi

          # Determine emoji and color
          if [ "$OVERALL" = "success" ]; then
            EMOJI="✅"
            COLOR="good"
            TITLE="All Checks Passed"
          else
            EMOJI="❌"
            COLOR="danger"
            TITLE="Some Checks Failed"
          fi

          # Build summary
          SUMMARY="$PASSED/$TOTAL passed"
          if [ "$FAILED" != "0" ]; then
            SUMMARY="$SUMMARY, $FAILED failed"
          fi
          if [ "$SKIPPED" != "0" ]; then
            SUMMARY="$SUMMARY, $SKIPPED skipped"
          fi

          # Build stage details
          DETAILS=""
          if [ -n "$PASSED_STAGES" ]; then
            DETAILS="✅ *Passed:* $PASSED_STAGES"
          fi
          if [ -n "$FAILED_STAGES" ]; then
            if [ -n "$DETAILS" ]; then
              DETAILS="$DETAILS\n"
            fi
            DETAILS="${DETAILS}❌ *Failed:* $FAILED_STAGES"
          fi

          # Send to Slack
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"$EMOJI Testnet Sentinel - $TITLE\",
              \"attachments\": [
                {
                  \"color\": \"$COLOR\",
                  \"fields\": [
                    {
                      \"title\": \"Summary\",
                      \"value\": \"$SUMMARY\",
                      \"short\": false
                    },
                    {
                      \"title\": \"Stage Results\",
                      \"value\": \"$DETAILS\",
                      \"short\": false
                    },
                    {
                      \"title\": \"Network\",
                      \"value\": \"Stagenet\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Run Details\",
                      \"value\": \"<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View on GitHub>\",
                      \"short\": true
                    }
                  ],
                  \"footer\": \"Testnet Sentinel\",
                  \"ts\": $(date +%s)
                }
              ]
            }"

      - name: Fail if any stage failed
        if: always()
        run: |
          if [ -f badges/status.json ]; then
            if grep -q '"failed"' badges/status.json; then
              echo "One or more stages failed"
              exit 1
            fi
          fi

